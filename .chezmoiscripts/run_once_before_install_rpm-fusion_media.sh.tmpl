#!/bin/bash

{{- if ge .level 3}}

if ! [[ $(dnf repolist | grep 'RPM Fusion') ]]; then
  echo
  echo ">>>rpm fusion repository could not be found, starting installation"
  echo
  sudo dnf install https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm
  echo
  sudo dnf config-manager setopt fedora-cisco-openh264.enabled=1
  echo
  sudo dnf update @core
  echo
fi

sudo dnf swap ffmpeg-free ffmpeg --allowerasing
echo
sudo dnf update @multimedia --setopt="install_weak_deps=False" --exclude=PackageKit-gstreamer-plugin

VENDOR=$(lspci | grep -oP 'VGA compatible controller: \K\w+')

if [[ "$VENDOR" == "NVIDIA" ]]; then
  sudo dnf install libva-nvidia-driver.{i686,x86_64}
elif [[ "$VENDOR" == "Intel" ]]; then
  sudo dnf install intel-media-driver
elif [[ "$VENDOR" == "AMD" ]]; then
  sudo dnf swap mesa-va-drivers mesa-va-drivers-freeworld
  sudo dnf swap mesa-vdpau-drivers mesa-vdpau-drivers-freeworld
  sudo dnf swap mesa-va-drivers.i686 mesa-va-drivers-freeworld.i686
  sudo dnf swap mesa-vdpau-drivers.i686 mesa-vdpau-drivers-freeworld.i686
fi

{{- end -}}
